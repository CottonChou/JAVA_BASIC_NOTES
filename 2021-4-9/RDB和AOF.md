## 简述 Redis 持久化中 rdb 以及 aof 方案的优缺点

**RDB持久化**

RDB是二进制文件，适合左冷备份，和全量复制。RDB持久化既可以手动也可以通过配置文件配置自动定期执行。

每一次Redis启动的时候会自动检测是否有RDB文件存在，存在则会自动加载。加载的时候是阻塞状态。值得注意的是，如果有AOF文件存在，会优先加载AOF文件，因为AOF文件的内容往往更加完整一点。

可以通过手动执行SAVE或者BGSAVE来进行RDB持久化，虽然BGSAVE是开启了一个子进程来避免阻塞，但是BGSAVE仍然会与以下命令排斥。

- 不能与SAVE同时执行
- 不能与BGREWRITEAOF同时执行

缺点：RDB方式数据没办法做到实时持久化/秒级持久化。因为每次运行都要执行fork操作创建子进程，属于重量级操作，频繁执行成本过高。

**AOF持久化**

AOF是基于Redis自己的一套协议的持久化。AOF持久化会把每条执行的命令追加到服务器内存的AOF_BUF缓冲区，每次执行完命令之后会基于配置考虑是否将缓冲区的内存刷到磁盘，因为AOF记录的是命令，服务器还原数据的时候会建立一个伪客户端。使用伪客户端执行AOF里面的命令，达到还原现场的效果。也正是因为AOF存的是命令，有时候为了达到一个状态，可能反复会执行多条命令，AOF会记录了很多多余的命令，而导致文件体积特别大，Redis有一个AOF重写的技术.直接读取当前服务器数据库的状态，来重新建立一个AOF文件，aof重写的时候，服务器会将重写期间收到的命令继续记录在aof_buf缓冲区，重写完成之后继续刷刷缓冲区再利用操作系统提供的原子性操作对文件重命名覆盖旧的AOF文件。

**优点**

AOF比起RDF可以更加实时的持久化数据，还可以通过AOF文件的命令做到灾难性后的误删除恢复。

**缺点**

因为是通过秒级别的或者每条命令执行完毕就追加到AOF文件，AOF持久化策略会导致redis的QPS不如RDB。

AOF恢复的 速度也比RDB慢。
