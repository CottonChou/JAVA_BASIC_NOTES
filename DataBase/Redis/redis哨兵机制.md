## Sentinel

> 哨兵是`redis`的高可用解决方案，由一个或者多个哨兵实例组成的哨兵系统，可以监视任意多个服务器，以及他们所属的从服务器。在所监视的主服务器下线后自动将其属下的某个从服务i其升级为主服务器。

在哨兵启动的时候时，服务器初始化一个`sentinelState`结构，保存了所有和哨兵功能有关的状态。一个`sentinelRedisInstance`保存监视的`redis`服务器实例（包括master,slave,其他哨兵）

哨兵状态初始化后，会根据配置文件对`master`属性进行初始化，对于每个被哨兵监视的主服务来说，哨兵会成为主服务器的客户端，创建两个连向主服务器的异步连接。

- 命令连接：向主服务器发送命令，并接受回复。
- 订阅连接：用于订阅主服务器的_`_sentinel_:hello`频道，防止命令丢失。

**获取主服务器的信息**

哨兵默认会以10秒依次的频率向主服务器发送`INFO`命令，以获取主服务器当前的信息，run_id,角色，slave信息。然后根据返回的信息更新自己保存的主服务器的信息。

**获取从服务器的信息**

当sentinel从master那里获取到了新的从服务器，会在自己这里创建一个新的对应的实例结构，还要创建命令连接和订阅连接。也是每隔十秒发送`INFO`，获取从服务器的信息。比如对应的主服务器是谁，优先级，复制偏移量。

**与其他sentinel的通信**

两秒一次的频率向订阅的`sentinel：hello`发送自己的信息，对于监视同一个服务器的多个`sentinel`,就会收到彼此的信息，用于更新自己的对其他sentinel和监视的master的认知。

感知到有其他的sentinel，就会与其相护建立命令连接。

**故障转移**

- 主观下线

默认情况下，sentinel会以一秒一次的频率向所有和自己建立的命令链接的服务器（master,sentinel,slave）发送ping命令，通过返回值判断该实例是否在线，如果在配置的超时时间内一直无响应，就修改实例对应的结构`sentinelRedisInstance`，标记为主观下线。

- 客观下线

当哨兵将一个主服务器判断主管下线后，回向其他监视这个服务器的哨兵进行询问，看他们是否也人为这个服务器下下了，达到足够数量`quorum`（配置文件配置的大多数个）个sentinel人为此服务器下线了，那么哨兵就将其判断为客观下线，并对齐进行故障转移。

- 故障转移

此时监视这个下线服务器的各个sentinel会进行协商，利用raft里面的选举算法选举出一个领头人选举出一个领头sentinel

领头的sentinel会选一个状态良好，数据最完整的从服务器，向这个从服务器发送`slave no one`命令，让他成为主服务器。

让其他的从服务器改为复制新的主服务器，将已经下线的主服务器设置为复制新的从服务器。