## 复制

在`redis`中可以通过执行`slave of`命令或者设置`slave of`选项来让一个从服务器去复制另外一个服务器。

`redis`的复制功能分为*同步（psync）*和*命令传播*两个操作。

- 同步操作用于将从服务器的数据库更新到主服务器当前所处的数据库状态。
- 命令操作用于在主服务数据库状态被修改，导致主从数据库状态不一致的时候，让主从数据库重回到一致性状态。

### 同步

同步分为完整同步和部分重同步两种模式

**完整重同步**

用于处理初次复制，执行步骤。

- 从服务器向主服务发送`psync`命令
- master执行`bgsave`命令，在后台生成RDB文件，并使用一个缓冲区来记录之后执行的命令。
- 主服务器生成`rdb`文件后，发送给从服务器，从服务器开始载入`rdb`文件，此期间阻塞不能接收客户端的命令请求。
- 主服务将缓冲区的命令发送给我i从服务器，从服务器执行后达到和master一直的状态。

**部分重同步**

部分重同步用于断线后的复制。当从服务器重新连接上主服务器，条件允许的话，主服务器会将从服务器掉线期间执行的命令发送给从服务器，从服务器执行这些命令达到一致性状态。

构成部分重同步的三个部分：

- 主从服务器的复制偏移量

1. 主服务器每次向从服务器发送N个字节的数据，就将自己的复制偏移量加N
2. 从服务器每次从主服务器收的N个字节的数据，就佳能自己的复制偏移量加N

- 主服务器的复制积压缓冲区

复制积压缓冲区是一个固定大小的`FIFO`队列，默认大小1MB.当主服务器向从服务器进行命令传播的时候，将命令写入复制积压缓冲区，缓冲区保存了最近传播的命令和每个字节的偏移量。

当从服务器掉线后重连，会发送`psync`命令，将自己的复制偏移量`offset`发送给主服务器，主服务器根据复制偏移量决定对从服务器发起完整冲同步还是部分重同步。

这个判定很简单，当`offset+1`在缓冲区里面，就部分重同步，反之就是完整重同步。

- 服务器运行的ID

每个`redis`都有一个运行的ID

从服务器初次复制的时候，主服务器回佳能自己的运行ID发送给从服务器。从服务器将主服务器的运行ID保存下来。

达能从服务器断线重连后，回想主服务器发送之前保存的主服务器运行ID，对的上就开始整部分冲同步，对不上就执行完整重同步。

**复制的实现**

- 设置主服务器的地址和端口

- 从服务器发送`slaveof masterip port`

- 从服务器保存主服务器的地址和端口信息

  ```c
  struct redisServer{
      char *masterhost
      char *masterport
  }
  ```

- 主服务器向从服务器返回`OK`，开始复制

- 从服务建立连接向主服务器的套接字连接，关联一个专门用于复制的文件事件处理器
- 从服务去发送`ping`，如果主服务器返回`pong`，继续下一个步骤
- 验证身份后开始同步
- 同步后开始命令传播



