## RedisCluster

通过配置`cluster-enable = yes`开启集群模式。如果是在集群中的话，那么一个redis服务器就会被视为一个节点。使用单独的数据结构保存节点的信息。

`clusterNode`记录自己的信息

```c
struct clusterNode{
    //节点的名字
    char name[REDIS_CLUSTER_NAMELEN]
    //节点标志 上线 下线 主从
    int flag
   //配置的纪元
   uint64_t configEpoch
   //连接节点的相关信息
   clusterLink *link
   //保存节点处理的槽
  unsigned char slots[16484/8]
//处理的槽的个数
  int numslots
}
```

节点之间通过握手老确定彼此的存在，为以后的进一步通信打好基础。

**槽指派**

redis集群通过分片的形式来保存数据库的键值对，整个数据库被分为16384个槽，每个集群最多可以处理也是这么多，当数据库中所有槽都有节点在处理的时候，集群处于上线状态，否则处于下线状态。

通过向节点发送 `cluster addslots`指令可以将一个槽或者多个派给节点负责。每个节点除了将自己的槽记录下来之外，还要告知其他的节点自己负责的槽，其他节点接收到消息更新自己记录的槽指派信息。这样集群中额每个节点都知道数据库的16384个槽的指派信息。

**在集群中执行命令**

达能客户端发送与数据库键有关的命令的时候，接受命令的节点会计算出要处理这个命令属于哪个槽，并检查这个槽是不是指派给了自己。

指派给了自己，直接执行命令。

没有指派给自己向客户端返回一个moved错误，并指引客户端转向正确的节点，客户端再发送一次命令。集群中的节点接收到moved错误，会自动转向不会打印错误。单机模式的客户端就会打印错误、

**重新分片**

Redis集群可以佳能任意数量的已经指派的槽改派给另外一个节点，这个是由redis集群管理软件来执行的。如果节点A正在迁移槽给节点B的话，当节点A找不到到客户端命令只当的键，节点A返回给客户端一个ASK错误，指引客户端到节点B继续查找。这个时候客户端请求B的话要预先发送一个asking，不然会被拒绝执行。

**故障迁移**

Redis集群节点可分为master和slave，master用于处理槽，而从节点用于复制主节点，并且再主节点下线后选出一个替代节点继续处理命令请求。

- 判断宕机下线

Redis集群中的每个节点都会定期的向其他节点发送ping命令，检测对方是否在线，在规定时间内没有返回pong，就认位对方疑似下线，之后和其他主节点进行通信，询问他们是否认位该节点下线，达能超过半数节点认位该节点下线的时，将这个节点标记为下线。对所有节点进行广播。

之后的选举就根sentinel，raft算法类似了。

新的主节点会撤销所有对下线主节点的槽指派，并将槽指派给自己。成功后会广播一次，让集群中其他节点知晓。

故障转移后再处理命令请求。